zstyle ':vcs_info:*' enable hg git svn
zstyle ':vcs_info:hg*:*' get-bookmarks true
zstyle ':vcs_info:*' get-revision true
zstyle ':vcs_info:*' check-for-changes true

zstyle ':vcs_info:*:*' unstagedstr "+"
zstyle ':vcs_info:git*:*' stagedstr "^"
# zstyle ':vcs_info:hg*:*' hgrevformat "%r:%12.12h"
zstyle ':vcs_info:hg*:*' hgrevformat "%r" # only show local rev.
zstyle ':vcs_info:*:*' branchformat "%b" # only show branch

zstyle ':vcs_info:hg*' formats "%b%m:%i%u"
zstyle ':vcs_info:hg*' actionformats "%b%m:%i%u»%a"
zstyle ':vcs_info:git*' formats "%b%m@%12.12i%u"
zstyle ':vcs_info:git*' actionformats "%b%m@%12.12i%u»%a"

zstyle ':vcs_info:hg+gen-hg-bookmark-string:*' hooks hg-bookmarks
function +vi-hg-bookmarks() {
    local s i
    # The bookmarks returned by `hg' are available in
    # the functions positional parameters.
    for i in "$@"; do
        # I frequently use hg-git, which creates a master bookmark, I'd prefer for that to be ignored
        if [[ $i != "master" ]]; then
            [[ -n $s ]] && s=$s,
            s=${s}$i
        fi
    done
    # tiny styling tweak when bookmark exists
    [[ -n $s ]] && s=/$s
    hook_com[hg-bookmark-string]=$s
    ret=1
    return 0
}


zstyle ':vcs_info:hg+set-hgrev-format:*' hooks hg-shorthash
function +vi-hg-shorthash() {
    local -a parents

    parents=( ${(s:+:)hook_com[hash]} )
    parents=( ${(@r:12:)parents} )
    hook_com[rev-replace]=${(j:+:)parents}

    ret=1
}

# Show time since last change for mercurial repos
+vi-hg-time-since() {
    local now=`date +%s`
    local last=$now

    if [ -f "$hook_com[base]/undo.dirstate" ]; then
        last=`last-modified $hook_com[base]/undo.dirstate`
    fi

    local since=$(( $now - $last ))
    if [[ $since -lt 3600 ]]; then
        since=$(( $since / 60 ))m
    elif [[ $since -lt 86400 ]]; then
        since=$(( $since / 3600 ))h
    else
        since=$(( $since / 86400 ))d
    fi

    # jam time-since in front of branch
    hook_com[branch]="$since:${hook_com[branch]}"
}

zstyle ':vcs_info:hg+set-hgrev-format:*' hooks hg-storerev
zstyle ':vcs_info:hg+set-message:*' hooks hg-branchhead hg-time-since

# The hash is available in the hgrev-format hook, store a copy of it in the
# user_data array so we can access it in the second function
function +vi-hg-storerev() {
    user_data[hash]=${hook_com[hash]}
}

function +vi-hg-branchhead() {
    local branchheadsfile i_tiphash i_branchname
    local -a branchheads

    local branchheadsfile=${hook_com[base]}/.hg/cache/branchheads

    # Bail out if any mq patches are applied
    [[ -s ${hook_com[base]}/.hg/patches/status ]] && return 0

    if [[ -r ${branchheadsfile} ]] ; then
        while read -r i_tiphash i_branchname ; do
            branchheads+=( $i_tiphash )
        done < ${branchheadsfile}

        if [[ ! ${branchheads[(i)${user_data[hash]}]} -le ${#branchheads} ]] ; then
            hook_com[revision]="!${hook_com[revision]}"
        fi
    fi
}

# Uncomment this for verbose debugging info
# zstyle ':vcs_info:*+*:*' debug true

# vim: ft=zsh
