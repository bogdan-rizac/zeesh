### vi-mode / zeesh! plugin

autoload -U edit-command-line
zle -N edit-command-line

# switch vi mode mappings
bindkey -v

# unbind escape key combinations
bindkey -rpM viins '^['
bindkey -rpM vicmd '^['
bindkey -rpM viins ''
bindkey -rpM vicmd ''

# bind keys
bindkey -M vicmd '^m' accept-line
bindkey -M vicmd 'u' undo
bindkey -M vicmd '^R' redo
bindkey -M vicmd 'ga' what-cursor-position
bindkey -M vicmd 'gg' vi-beginning-of-line
bindkey -M vicmd 'G' end-of-line
bindkey -M vicmd 'db' backward-kill-word
bindkey -M vicmd 'dd' kill-whole-line
bindkey -M vicmd 'd$' vi-kill-eol
bindkey -M vicmd 'd^' vi-kill-line
bindkey -M vicmd 'yy' vi-yank-whole-line
bindkey -M vicmd 'Y' vi-yank-eol
bindkey -M vicmd 'y.' vi-yank-whole-line
bindkey -M vicmd 'c.' vi-change-whole-line
bindkey -M viins '^k' history-search-backward
bindkey -M vicmd '^k' history-search-backward
bindkey -M viins '^j' history-search-forward
bindkey -M vicmd '^j' history-search-forward
bindkey -M viins '^n' history-search-backward
bindkey -M vicmd '^n' history-search-backward
bindkey -M viins '^p' history-search-forward
bindkey -M vicmd '^p' history-search-forward
bindkey -M viins '^U' vi-change-whole-line
bindkey -M vicmd '^U' vi-change-whole-line
# bindkey -M vicmd '\e[H'  vi-beginning-of-line
# bindkey -M vicmd '\e[F'  vi-end-of-line
# bindkey -M vicmd '^[[1~' vi-beginning-of-line
# bindkey -M vicmd '^[[4~' vi-end-of-line
# bindkey '^[[2~' beep
# bindkey '^[[3~' delete-char
# bindkey '^[[5~' vi-backward-blank-word
# bindkey '^[[6~' vi-forward-blank-word
bindkey -M viins '' backward-delete-char
bindkey -M vicmd '' backward-delete-char
# bindkey -M vicmd '^[[3~' delete-char
bindkey -M vicmd '^e' edit-command-line
bindkey -M viins '^e' edit-command-line

# zle widget to enter normal mode without moving cursor back
zle-esc-in-place() {
    zle -K vicmd
}
zle -N zle-esc-in-place
bindkey -M viins '' zle-esc-in-place
bindkey -M vicmd '' zle-esc-in-place
bindkey -M viins '^[' zle-esc-in-place
bindkey -M vicmd '^[' zle-esc-in-place

# delete from cursor position to end of word and stay in normal mode
zle-vicmd-dw() {
    zle kill-word
    zle -K vicmd
}
zle -N zle-vicmd-dw
bindkey -M vicmd 'dw' zle-vicmd-dw

# delete current word and stay in normal mode
zle-vicmd-diw() {
    zle backward-word
    zle kill-word
    zle -K vicmd
}
zle -N zle-vicmd-diw
bindkey -M vicmd 'diw' zle-vicmd-diw

# delete from current positon to end of word and change to insert mode
zle-vicmd-cw() {
    zle kill-word
    zle -K viins
}
zle -N zle-vicmd-cw
bindkey -M vicmd 'cw' zle-vicmd-cw

# delete current word and change to insert mode
zle-vicmd-ciw() {
    zle backward-word
    zle kill-word
    zle -K viins
}
zle -N zle-vicmd-ciw
bindkey -M vicmd 'ciw' zle-vicmd-ciw

if [ -n $ZEESH_VI_VISUAL_MODE_ENABLED ]; then
    bindkey -rpM vivis ''
    bindkey -rpM vivis '^['
    bindkey -M vivis '' zle-esc-in-place
    bindkey -M vivis '^[' zle-esc-in-place
fi

if [ -n $ZEESH_HISTORY_SUBSTRING_SEARCH_ENABLED ]; then
    bindkey -r viins "^R"
    bindkey -M viins '^k' history-substring-search-down
    bindkey -M vicmd '^k' history-substring-search-down
    bindkey -M viins '^j' history-substring-search-up
    bindkey -M vicmd '^j' history-substring-search-up
    bindkey -M viins '^n' history-substring-search-up
    bindkey -M vicmd '^n' history-substring-search-up
    bindkey -M viins '^p' history-substring-search-down
    bindkey -M vicmd '^p' history-substring-search-down
fi

# zle-ctrl-c-remap() {
#     # zle kill-buffer
#     # zle -K viins
#     zle reset-prompt
#     zle send-break
# }
# zle -N zle-ctrl-c-remap
# trap 'zle && [[ -z $curcontext ]] && zle kill-buffer && zle reset-prompt' INT
